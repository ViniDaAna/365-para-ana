<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entre Nós Dois</title>

  <link rel="icon" href="data:," />
  <!-- cache-buster -->
  <link rel="stylesheet" href="style.css?v=20260228_4" />
</head>

<body>

  <!-- LOGIN -->
  <div class="container" id="login">
    <div class="corner-date" id="cornerDateLogin"></div>

    <h1 class="title">Um Lugar Só Nosso</h1>
    <div class="thin-line"></div>
    <p class="subtitle">Digite a data que tudo começou</p>

    <input type="password" id="senha" placeholder="Senha" />
    <br />
    <button type="button" onclick="verificarSenha()">Entrar</button>

    <div class="meta">Dica: o dia em que a gente virou “nós”.</div>
  </div>

  <!-- CONTEÚDO -->
  <div class="container hidden" id="conteudo">
    <div class="corner-date" id="cornerDate"></div>

    <div id="fraseContexto" class="meta" style="margin-top:4px;"></div>
    <div id="modoTeste" class="meta hidden" style="margin-top:6px; opacity:.9;"></div>

    <h2 id="tituloTopo" class="title"></h2>
    <div class="thin-line"></div>

    <div id="blocoTexto" class="fade">

      <!-- INTRODUÇÃO DE ATO -->
      <div id="introAtoBox" class="extra hidden">
        <div class="extraTag" id="introAtoTag">Novo Ato</div>
        <div class="extraTexto" id="introAtoTexto"></div>
        <button class="btnIntro" id="btnContinuarAto" type="button">Continuar</button>
      </div>

      <!-- POEMA / TEXTO PRINCIPAL -->
      <div class="poema" id="poema"></div>

      <!-- ===== ATO 2 — LINHAS + PENSAMENTO OCULTO (31–90) ===== -->
      <div id="ato2Lines" class="ato2Lines hidden" aria-hidden="true">
        <div class="ato2Line"></div>
        <div class="ato2Line"></div>
        <div class="ato2Line"></div>
      </div>

      <!-- Tooltip (fixo, pra não cortar) -->
      <div id="ato2Thought" class="ato2Thought hidden" aria-hidden="true"></div>
      <!-- ===== /ATO 2 ===== -->

      <div class="meta" id="meta"></div>

      <!-- ===== ATO 1 — ENTRELINHAS (1–30) ===== -->
      <div id="ato1Chave" class="ato1Chave hidden" aria-hidden="true">
        <div class="ato1Label">ENTRELINHAS</div>
        <div class="ato1PalavraWrap">
          <span id="ato1Palavra" class="ato1Palavra"></span>
        </div>
      </div>

      <div id="ato1Montagem" class="ato1Montagem hidden" aria-hidden="true"></div>
      <!-- ===== /ATO 1 ===== -->

      <!-- ===== DIA 365 — GATILHO DA CÁPSULA ===== -->
      <div id="capsulaTrigger" class="capsulaTrigger hidden">
        <div class="capsulaTitle">Cápsula do tempo.</div>
        <div class="capsulaMeta">Escrita em 23/02/2025.</div>
        <button id="btnAbrirCapsula" class="btnCapsula" type="button">Abrir</button>
      </div>

      <!-- ARQUIVO: POEMAS -->
      <div id="arquivoBox" class="arquivoBox hidden">
        <div class="arquivoHeader">
          <button class="ghostBtn" type="button" onclick="voltarParaHoje()">Voltar</button>

          <div class="arquivoHeaderText">
            <div class="titleSmall">Poemas anteriores</div>
            <div class="metaSmall" id="arquivoSub">—</div>
          </div>

          <div style="width:72px;"></div>
        </div>

        <div class="thin-line" style="margin-top:18px;"></div>

        <div class="rangeRow" id="rangeRow"></div>
        <div id="listaArquivo" class="arquivoLista"></div>
      </div>

      <!-- ARQUIVO: MEMÓRIAS -->
      <div id="memoriasBox" class="arquivoBox hidden">
        <div class="arquivoHeader">
          <button class="ghostBtn" type="button" onclick="voltarParaHoje()">Voltar</button>

          <div class="arquivoHeaderText">
            <div class="titleSmall">Memórias</div>
            <div class="metaSmall" id="memoriasSub">—</div>
          </div>

          <div style="width:72px;"></div>
        </div>

        <div class="thin-line" style="margin-top:18px;"></div>
        <div id="listaMemorias" class="arquivoLista"></div>
      </div>

    </div>

    <div class="btnRow" id="botoesNormal">
      <button id="btnAnteriores" type="button" onclick="abrirArquivo()">Poemas anteriores</button>
      <button id="btnMemorias" type="button" onclick="abrirMemorias()">Memórias</button>
      <button type="button" onclick="mostrarSaudade()">Clique aqui quando estiver com saudade</button>
    </div>

    <div class="btnRow hidden" id="botoesArquivo">
      <button class="ghostBtn" type="button" onclick="voltarParaHoje()">Voltar para o dia de hoje</button>
    </div>

    <div id="saudade" class="saudade hidden">
      Se você sentiu saudade, é porque o que temos é real.
      E eu escolho você — hoje e todos os dias.
    </div>

    <div class="assinatura">Entre nós dois.</div>

    <!-- Toast -->
    <div id="toastSegredo" class="toast hidden" aria-live="polite"></div>

    <!-- Fade final -->
    <div id="fadeOverlay" class="fadeOverlay" aria-hidden="true"></div>
  </div>

  <!-- ✅ cache-buster novo -->
  <script src="poemas.js?v=20260228_4"></script>

  <script>
    const senhaCorreta = "10022024";
    const dataInicioPadrao = new Date("2026-02-24T00:00:00");
    const START_OVERRIDE_KEY = "projeto365_start_override";

    let DIA_ATUAL = 1;
    let DIA_EM_TELA = 1;

    const INTRO_ATOS = {
      31: { tag: "Ato 2 — Conexão", texto:
`Agora a gente se permite chegar mais perto.
Menos defesa.
Mais verdade.

Se o Ato 1 foi escolha,
o Ato 2 é presença.` },
      91: { tag: "Ato 3 — Fogo", texto:
`A intensidade não é pressa.
É entrega consciente.

Aqui, o desejo aparece
com elegância — e coragem.` }
    };

    // ✅ MODO TESTE: /?day=60
    function getForcedDay(){
      try{
        const p = new URLSearchParams(location.search);
        const raw = p.get("day");
        if(!raw) return null;
        const n = Number(raw);
        if(Number.isFinite(n) && n >= 0 && n <= 365) return Math.floor(n);
        return null;
      }catch(e){ return null; }
    }

    function showModoTeste(dia){
      const el = document.getElementById("modoTeste");
      if(dia === null){
        el.classList.add("hidden");
        el.textContent = "";
        return;
      }
      el.classList.remove("hidden");
      el.textContent = `Modo teste ativo: Dia ${dia}. (URL: ?day=${dia})`;
    }

    function getDataInicio(){
      const iso = localStorage.getItem(START_OVERRIDE_KEY);
      if(iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)){
        return new Date(iso + "T00:00:00");
      }
      return dataInicioPadrao;
    }

    function diffDias(){
      const dataInicio = getDataInicio();
      const hoje = new Date();
      const H = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
      const I = new Date(dataInicio.getFullYear(), dataInicio.getMonth(), dataInicio.getDate());
      return Math.floor((H - I) / (1000*60*60*24));
    }

    function getAto(dia){
      if(dia >= 1 && dia <= 30) return 1;
      if(dia >= 31 && dia <= 90) return 2;
      if(dia >= 91 && dia <= 150) return 3;
      if(dia >= 151 && dia <= 240) return 4;
      if(dia >= 241 && dia <= 330) return 5;
      return 6;
    }

    function setTemaPorAto(dia){
      document.body.setAttribute("data-ato", String(getAto(dia)));
    }

    function setDayAttr(dia){
      if(dia >= 1 && dia <= 365) document.body.setAttribute("data-dia", String(dia));
      else document.body.removeAttribute("data-dia");
    }

    function setCornerDates(){
      const agora = new Date();
      const dd = String(agora.getDate()).padStart(2,'0');
      const mm = String(agora.getMonth()+1).padStart(2,'0');
      const yyyy = agora.getFullYear();
      const data = `${dd}/${mm}/${yyyy}`;
      document.getElementById("cornerDateLogin").innerText = data;
      document.getElementById("cornerDate").innerText = data;
    }

    function aplicarFrasePorHorario(){
      const hora = new Date().getHours();
      const el = document.getElementById("fraseContexto");
      if(hora >= 5 && hora < 12) el.innerText = "Que seu dia seja leve. Eu já escolhi você hoje.";
      else if(hora >= 12 && hora < 18) el.innerText = "No meio do seu dia, eu ainda penso em você.";
      else if(hora >= 18 && hora < 23) el.innerText = "Eu gosto quando você vem aqui no fim do dia.";
      else el.innerText = "Eu gosto quando você aparece antes de dormir.";
    }

    function verificarRetorno(){
      const hoje = new Date().toDateString();
      const key = "projeto365_visita";
      const ultima = localStorage.getItem(key);
      if(ultima === hoje){
        const el = document.getElementById("fraseContexto");
        el.innerText += " Você voltou. Eu gosto disso.";
      }
      localStorage.setItem(key, hoje);
    }

    function revelarBloco(){
      const bloco = document.getElementById("blocoTexto");
      bloco.classList.remove("show");
      void bloco.offsetWidth;
      bloco.classList.add("show");
    }

    let typingTimer = null;
    function typeText(el, text, speed=12, onDone=null){
      clearTimeout(typingTimer);
      el.textContent = "";
      let i = 0;
      function step(){
        el.textContent = text.slice(0, i);
        i++;
        if(i <= text.length){
          typingTimer = setTimeout(step, speed);
        } else {
          if(typeof onDone === "function") onDone();
        }
      }
      step();
    }

    // ===== INTRO DE ATO =====
    function introKeyForDay(dia){ return `projeto365_intro_vista_${dia}`; }
    function deveMostrarIntro(dia){
      if(dia !== DIA_ATUAL) return false;
      if(!INTRO_ATOS[dia]) return false;
      return localStorage.getItem(introKeyForDay(dia)) !== "1";
    }
    function marcarIntroComoVista(dia){ localStorage.setItem(introKeyForDay(dia), "1"); }
    function esconderIntro(){
      const box = document.getElementById("introAtoBox");
      box.classList.add("hidden");
      document.getElementById("introAtoTexto").textContent = "";
    }
    function mostrarIntro(dia){
      const info = INTRO_ATOS[dia];
      const box = document.getElementById("introAtoBox");
      const tag = document.getElementById("introAtoTag");
      const txt = document.getElementById("introAtoTexto");
      const btn = document.getElementById("btnContinuarAto");

      tag.textContent = info.tag;
      txt.textContent = info.texto;

      box.classList.remove("hidden");

      btn.onclick = () => {
        marcarIntroComoVista(dia);
        esconderIntro();
        carregarPoema(dia);
      };
    }

    // ===== ATO 2 — LINHAS + SUBLINHADO (CORRIGIDO) =====
    function esconderAto2UI(){
      const lines = document.getElementById("ato2Lines");
      const tip = document.getElementById("ato2Thought");
      lines.classList.add("hidden");
      lines.setAttribute("aria-hidden","true");
      tip.classList.add("hidden");
      tip.setAttribute("aria-hidden","true");
      tip.textContent = "";
    }

    function setAto2Lines(dia){
      const lines = document.getElementById("ato2Lines");
      if(getAto(dia) !== 2){
        lines.classList.add("hidden");
        lines.setAttribute("aria-hidden","true");
        return;
      }
      const t = Math.max(0, Math.min(1, (dia - 31) / 59)); // 31..90
      const gap = (30 - (t * 18)); // 30px -> 12px
      lines.style.setProperty("--ato2Gap", `${gap.toFixed(1)}px`);
      lines.classList.remove("hidden");
      lines.setAttribute("aria-hidden","false");
    }

    function escapeHTML(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ✅ NOVO: marcação por indexOf (não quebra com acento)
    function applyAto2Markup(dia){
      if(getAto(dia) !== 2) return;
      if(typeof getAto2Anotacoes !== "function") return;

      const anot = getAto2Anotacoes(dia) || [];
      if(!anot.length) return;

      const poemaEl = document.getElementById("poema");
      const rawOriginal = poemaEl.textContent || "";
      let raw = rawOriginal;

      // cria tokens estáveis
      const tokens = [];
      anot.forEach((a, idx) => {
        const target = (a && a.target) ? String(a.target) : "";
        const thought = (a && a.thought) ? String(a.thought) : "";
        if(!target.trim()) return;

        const pos = raw.indexOf(target);
        if(pos === -1) return;

        const token = `[[A2_${idx}]]`;
        tokens.push({ token, target, thought });

        raw = raw.slice(0, pos) + token + raw.slice(pos + target.length);
      });

      if(!tokens.length) return;

      // escapa e transforma quebras de linha
      let html = escapeHTML(raw).replaceAll("\n", "<br>");

      // substitui tokens por spans
      tokens.forEach((t) => {
        const safeThought = escapeHTML(t.thought);
        const safeTarget = escapeHTML(t.target);
        html = html.replace(t.token, `<span class="ato2Mark" data-thought="${safeThought}">${safeTarget}</span>`);
      });

      poemaEl.innerHTML = html;
    }

    function setupAto2Interactions(){
      const poemaEl = document.getElementById("poema");
      const tip = document.getElementById("ato2Thought");

      function hideTip(){
        tip.classList.add("hidden");
        tip.setAttribute("aria-hidden","true");
        tip.textContent = "";
      }

      function showTipFor(el){
        const thought = el.getAttribute("data-thought") || "";
        if(!thought.trim()) return;

        tip.textContent = thought;
        tip.classList.remove("hidden");
        tip.setAttribute("aria-hidden","false");

        const r = el.getBoundingClientRect();
        const pad = 10;

        const tipW = Math.min(520, window.innerWidth - 24);
        tip.style.width = tipW + "px";

        tip.style.left = "0px";
        tip.style.top = "0px";
        const tr = tip.getBoundingClientRect();

        let left = Math.max(12, Math.min(window.innerWidth - tr.width - 12, r.left + (r.width/2) - (tr.width/2)));
        let top = r.top - tr.height - pad;
        if(top < 12) top = r.bottom + pad;

        tip.style.left = left + "px";
        tip.style.top = top + "px";
      }

      poemaEl.addEventListener("click", (e) => {
        const t = e.target;
        if(!(t instanceof Element)) return;
        const mark = t.closest(".ato2Mark");
        if(!mark){ hideTip(); return; }

        const now = (mark.getAttribute("data-thought") || "");
        if(!tip.classList.contains("hidden") && tip.textContent === now){
          hideTip();
        }else{
          showTipFor(mark);
        }
      });

      poemaEl.addEventListener("mouseover", (e) => {
        const t = e.target;
        if(!(t instanceof Element)) return;
        const mark = t.closest(".ato2Mark");
        if(!mark) return;
        showTipFor(mark);
      });

      poemaEl.addEventListener("mouseout", (e) => {
        const t = e.target;
        if(!(t instanceof Element)) return;
        const mark = t.closest(".ato2Mark");
        if(!mark) return;
        clearTimeout(window.__ato2TipOut);
        window.__ato2TipOut = setTimeout(() => hideTip(), 120);
      });

      window.addEventListener("scroll", () => hideTip(), {passive:true});
      window.addEventListener("resize", () => hideTip());
      document.addEventListener("visibilitychange", () => hideTip());
    }

    function afterPoemTyped(dia){
      setAto2Lines(dia);
      applyAto2Markup(dia);
    }

    function carregarPoema(dia){
      DIA_EM_TELA = dia;

      const tituloTopo = document.getElementById("tituloTopo");
      const poemaEl = document.getElementById("poema");
      const metaEl = document.getElementById("meta");

      revelarBloco();

      setTemaPorAto(dia);
      setDayAttr(dia);

      esconderAto2UI();

      tituloTopo.innerText = `Dia ${dia} de 365`;
      metaEl.innerText = "Um poema por dia.";

      const texto = (typeof getPoemaDoDia === "function") ? getPoemaDoDia(dia) : "";
      const safe = (texto && String(texto).trim().length) ? String(texto) : "(Poema vazio / não carregou.)";

      typeText(poemaEl, safe, 12, () => afterPoemTyped(dia));
    }

    function carregarHoje(){
      const forced = getForcedDay();
      showModoTeste(forced);

      if(forced !== null){
        DIA_ATUAL = forced;

        aplicarFrasePorHorario();
        verificarRetorno();

        if(deveMostrarIntro(DIA_ATUAL)){
          revelarBloco();
          setTemaPorAto(DIA_ATUAL);
          setDayAttr(DIA_ATUAL);
          document.getElementById("tituloTopo").innerText = `Dia ${DIA_ATUAL} de 365`;
          document.getElementById("poema").textContent = "";
          document.getElementById("meta").textContent = "";
          esconderAto2UI();
          mostrarIntro(DIA_ATUAL);
          return;
        }

        esconderIntro();
        carregarPoema(DIA_ATUAL);
        return;
      }

      const d = diffDias();
      DIA_ATUAL = d + 1;

      aplicarFrasePorHorario();
      verificarRetorno();

      if(deveMostrarIntro(DIA_ATUAL)){
        revelarBloco();
        setTemaPorAto(DIA_ATUAL);
        setDayAttr(DIA_ATUAL);
        document.getElementById("tituloTopo").innerText = `Dia ${DIA_ATUAL} de 365`;
        document.getElementById("poema").textContent = "";
        document.getElementById("meta").textContent = "";
        esconderAto2UI();
        mostrarIntro(DIA_ATUAL);
        return;
      }

      esconderIntro();
      carregarPoema(DIA_ATUAL);
    }

    function voltarParaHoje(){ carregarHoje(); }
    function mostrarSaudade(){ document.getElementById("saudade").classList.toggle("hidden"); }

    function verificarSenha(){
      const senha = document.getElementById("senha").value;
      if(senha === senhaCorreta){
        document.getElementById("login").classList.add("hidden");
        document.getElementById("conteudo").classList.remove("hidden");
        setCornerDates();
        carregarHoje();
      } else {
        alert("Senha incorreta.");
      }
    }

    setCornerDates();
    setInterval(setCornerDates, 60000);

    setupAto2Interactions();
  </script>

</body>
</html>
