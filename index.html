<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Entre Nós Dois</title>

  <link rel="icon" href="data:," />
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <!-- LOGIN -->
  <div class="container" id="login">
    <div class="corner-date" id="cornerDateLogin"></div>

    <h1 class="title">Um Lugar Só Nosso</h1>
    <div class="thin-line"></div>
    <p class="subtitle">Digite a data que tudo começou</p>

    <input type="password" id="senha" placeholder="Senha" />
    <br />
    <button type="button" onclick="verificarSenha()">Entrar</button>

    <div class="meta">Dica: o dia em que a gente virou “nós”.</div>
  </div>

  <!-- CONTEÚDO (mesma tela: hoje / arquivo) -->
  <div class="container hidden" id="conteudo">
    <div class="corner-date" id="cornerDate"></div>

    <div id="fraseContexto" class="meta" style="margin-top:4px;"></div>

    <h2 id="tituloTopo" class="title"></h2>
    <div class="thin-line"></div>

    <div id="blocoTexto" class="fade">

      <!-- INTRODUÇÃO DE ATO -->
      <div id="introAtoBox" class="extra hidden">
        <div class="extraTag" id="introAtoTag">Novo Ato</div>
        <div class="extraTexto" id="introAtoTexto"></div>
        <button class="btnIntro" id="btnContinuarAto" type="button">Continuar</button>
      </div>

      <!-- MEMÓRIA DESBLOQUEÁVEL -->
      <div id="memoriaBox" class="memoriaBox hidden">
        <div class="memoriaHeader">
          <div class="memoriaTag">Memória desbloqueável</div>
          <div class="memoriaDia" id="memoriaDiaLabel">—</div>
        </div>

        <div class="memoriaPreview" id="memoriaPreview"></div>

        <div class="memoriaBtns">
          <button id="btnAbrirMemoria" type="button">Ler memória</button>
          <button id="btnFecharMemoria" class="ghostBtn hidden" type="button">Fechar</button>
        </div>

        <div id="memoriaTexto" class="memoriaTexto hidden"></div>
      </div>

      <!-- POEMA -->
      <div class="poema" id="poema"></div>
      <div class="meta" id="meta"></div>

      <!-- LISTA DO ARQUIVO (fica escondida no modo normal) -->
      <div id="arquivoBox" class="arquivoBox hidden">
        <div class="arquivoHeader">
          <button class="ghostBtn" type="button" onclick="voltarParaHoje()">Voltar</button>

          <div class="arquivoHeaderText">
            <div class="titleSmall">Poemas anteriores</div>
            <div class="metaSmall" id="arquivoSub">—</div>
          </div>

          <div style="width:72px;"></div>
        </div>

        <div class="thin-line" style="margin-top:18px;"></div>

        <div id="listaArquivo" class="arquivoLista"></div>
      </div>

    </div>

    <!-- Botões (normal) -->
    <div class="btnRow" id="botoesNormal">
      <button id="btnAnteriores" type="button" onclick="abrirArquivo()">Poemas anteriores</button>
      <button type="button" onclick="mostrarSaudade()">Clique aqui quando estiver com saudade</button>
    </div>

    <!-- Botões (modo arquivo) -->
    <div class="btnRow hidden" id="botoesArquivo">
      <button class="ghostBtn" type="button" onclick="voltarParaHoje()">Voltar para o dia de hoje</button>
    </div>

    <div id="saudade" class="saudade hidden">
      Se você sentiu saudade, é porque o que temos é real.
      E eu escolho você — hoje e todos os dias.
    </div>

    <div class="assinatura">Entre nós dois.</div>
  </div>

  <!-- Toast -->
  <div id="toastSegredo" class="toast hidden" aria-live="polite"></div>

  <script src="poemas.js"></script>

  <script>
    const senhaCorreta = "10022024";
    const dataInicio = new Date("2026-02-24T00:00:00");

    let DIA_ATUAL = 1;
    let DIA_EM_TELA = 1;

    // Introduções de virada (aparecem ANTES do poema, e só liberam após clique)
    const INTRO_ATOS = {
      31: {
        tag: "Ato 2 — Conexão",
        texto:
`Agora a gente se permite chegar mais perto.
Menos defesa.
Mais verdade.

Se o Ato 1 foi escolha,
o Ato 2 é presença.`
      },
      91: {
        tag: "Ato 3 — Fogo",
        texto:
`A intensidade não é pressa.
É entrega consciente.

Aqui, o desejo aparece
com elegância — e coragem.`
      },
      151: {
        tag: "Ato 4 — Crescimento",
        texto:
`O amor amadurece quando escolhe evoluir.

Não é sobre sentir mais.
É sobre cuidar melhor.`
      },
      241: {
        tag: "Ato 5 — Raiz",
        texto:
`Agora não é só sentir.
É pertencer.

O que era promessa
vira casa.`
      },
      331: {
        tag: "Ato 6 — Recomeço",
        texto:
`Escolher de novo
é a forma mais madura de amar.

O fim não fecha.
Ele renova.`
      }
    };

    const segredos = [
      "Eu ainda estou aqui.",
      "Você chegou. Eu já respirei melhor.",
      "Esse lugar é seu também.",
      "Eu escolho você, mesmo nos dias comuns.",
      "Se o mundo estiver barulhento, fica aqui um pouco.",
      "Eu gosto quando você volta.",
      "O que a gente tem merece cuidado.",
      "Eu não tenho pressa. Eu tenho certeza.",
      "Aqui é onde eu fico.",
      "Eu penso em você com calma.",
      "Mesmo em silêncio, eu continuo.",
      "Você é a minha decisão tranquila.",
      "Se você ler isso, é porque existe nós.",
      "Eu guardo você nas coisas pequenas.",
      "Não precisa de nada grandioso. Só de você aqui."
    ];

    // ===== util =====

    function diffDias(){
      const hoje = new Date();
      const H = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
      const I = new Date(dataInicio.getFullYear(), dataInicio.getMonth(), dataInicio.getDate());
      return Math.floor((H - I) / (1000*60*60*24));
    }

    function getAto(dia){
      if(dia >= 1 && dia <= 30) return 1;
      if(dia >= 31 && dia <= 90) return 2;
      if(dia >= 91 && dia <= 150) return 3;
      if(dia >= 151 && dia <= 240) return 4;
      if(dia >= 241 && dia <= 330) return 5;
      return 6;
    }

    function setTemaPorAto(dia){
      document.body.setAttribute("data-ato", String(getAto(dia)));
    }

    function setCornerDates(){
      const agora = new Date();
      const dd = String(agora.getDate()).padStart(2,'0');
      const mm = String(agora.getMonth()+1).padStart(2,'0');
      const yyyy = agora.getFullYear();
      const data = `${dd}/${mm}/${yyyy}`;

      document.getElementById("cornerDateLogin").innerText = data;
      document.getElementById("cornerDate").innerText = data;
    }

    function aplicarFrasePorHorario(){
      const hora = new Date().getHours();
      const el = document.getElementById("fraseContexto");

      if(hora >= 5 && hora < 12){
        el.innerText = "Que seu dia seja leve. Eu já escolhi você hoje.";
      } else if(hora >= 12 && hora < 18){
        el.innerText = "No meio do seu dia, eu ainda penso em você.";
      } else if(hora >= 18 && hora < 23){
        el.innerText = "Eu gosto quando você vem aqui no fim do dia.";
      } else {
        el.innerText = "Eu gosto quando você aparece antes de dormir.";
      }
    }

    function verificarRetorno(){
      const hoje = new Date().toDateString();
      const key = "projeto365_visita";
      const ultima = localStorage.getItem(key);

      if(ultima === hoje){
        const el = document.getElementById("fraseContexto");
        el.innerText += " Você voltou. Eu gosto disso.";
      }

      localStorage.setItem(key, hoje);
    }

    function revelarBloco(){
      const bloco = document.getElementById("blocoTexto");
      bloco.classList.remove("show");
      void bloco.offsetWidth;
      bloco.classList.add("show");
    }

    // Digitação
    let typingTimer = null;
    function typeText(el, text, speed=12){
      clearTimeout(typingTimer);
      el.textContent = "";
      let i = 0;

      function step(){
        el.textContent = text.slice(0, i);
        i++;
        if(i <= text.length){
          typingTimer = setTimeout(step, speed);
        }
      }
      step();
    }

    // ===== toast =====

    function pickSegredo(){
      return segredos[Math.floor(Math.random() * segredos.length)];
    }

    function mostrarToast(texto){
      const toast = document.getElementById("toastSegredo");
      toast.textContent = texto;

      toast.classList.remove("hidden");
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");

      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.classList.add("hidden"), 250);
      }, 4200);
    }

    function iniciarSegredo(){
      const cooldownKey = "projeto365_toast";
      const cooldownMs = 2 * 60 * 60 * 1000; // 2h
      let timer;

      function reset(){
        clearTimeout(timer);
        timer = setTimeout(() => {
          const last = Number(localStorage.getItem(cooldownKey) || 0);
          const now = Date.now();
          if(now - last > cooldownMs){
            localStorage.setItem(cooldownKey, String(now));
            mostrarToast(pickSegredo());
          }
        }, 10000);
      }

      window.addEventListener("mousemove", reset, {passive:true});
      window.addEventListener("keydown", reset);
      window.addEventListener("touchstart", reset, {passive:true});
      window.addEventListener("scroll", reset, {passive:true});

      reset();
    }

    // ===== intro de ato =====

    function introKeyForDay(dia){
      return `projeto365_intro_vista_${dia}`;
    }

    function deveMostrarIntro(dia){
      if(dia !== DIA_ATUAL) return false;
      if(!INTRO_ATOS[dia]) return false;
      return localStorage.getItem(introKeyForDay(dia)) !== "1";
    }

    function marcarIntroComoVista(dia){
      localStorage.setItem(introKeyForDay(dia), "1");
    }

    function esconderIntro(){
      const box = document.getElementById("introAtoBox");
      box.classList.add("hidden");
      document.getElementById("introAtoTexto").textContent = "";
    }

    function mostrarIntro(dia){
      const info = INTRO_ATOS[dia];
      const box = document.getElementById("introAtoBox");
      const tag = document.getElementById("introAtoTag");
      const txt = document.getElementById("introAtoTexto");
      const btn = document.getElementById("btnContinuarAto");

      tag.textContent = info.tag;
      txt.textContent = info.texto;

      box.classList.remove("hidden");

      btn.onclick = () => {
        marcarIntroComoVista(dia);
        esconderIntro();
        carregarPoema(dia);
      };
    }

    // ===== animação “folhear” =====

    function animarFolha(direcao){
      // direcao: "in" (entrar) ou "out" (sair)
      const c = document.getElementById("conteudo");
      c.classList.remove("pageflip-in", "pageflip-out");
      void c.offsetWidth;
      c.classList.add(direcao === "in" ? "pageflip-in" : "pageflip-out");

      clearTimeout(window.__flipTimer);
      window.__flipTimer = setTimeout(() => {
        c.classList.remove("pageflip-in", "pageflip-out");
      }, 520);
    }

    // ===== modo arquivo (folha) =====

    function entrarModoArquivo(){
      document.body.classList.add("modo-arquivo");

      document.getElementById("arquivoBox").classList.remove("hidden");
      document.getElementById("botoesNormal").classList.add("hidden");
      document.getElementById("botoesArquivo").classList.remove("hidden");
      document.getElementById("saudade").classList.add("hidden");

      // limpa poeminha enquanto está no arquivo
      document.getElementById("poema").textContent = "";
      document.getElementById("meta").textContent = "";
      esconderIntro();
      esconderMemoriaUI();

      document.getElementById("tituloTopo").innerText = "Arquivo";

      animarFolha("in");
    }

    function sairModoArquivo(){
      if(document.body.classList.contains("modo-arquivo")){
        animarFolha("out");
      }

      document.body.classList.remove("modo-arquivo");
      document.getElementById("arquivoBox").classList.add("hidden");
      document.getElementById("botoesNormal").classList.remove("hidden");
      document.getElementById("botoesArquivo").classList.add("hidden");
    }

    // ===== memórias =====

    function memoriaKeyForDay(dia){
      return `projeto365_memoria_vista_${dia}`;
    }

    function esconderMemoriaUI(){
      const box = document.getElementById("memoriaBox");
      const texto = document.getElementById("memoriaTexto");
      const btnFechar = document.getElementById("btnFecharMemoria");

      box.classList.add("hidden");
      texto.classList.add("hidden");
      texto.textContent = "";
      btnFechar.classList.add("hidden");
    }

    function renderizarMemoria(dia){
      const box = document.getElementById("memoriaBox");
      const preview = document.getElementById("memoriaPreview");
      const labelDia = document.getElementById("memoriaDiaLabel");
      const btnAbrir = document.getElementById("btnAbrirMemoria");
      const btnFechar = document.getElementById("btnFecharMemoria");
      const textoEl = document.getElementById("memoriaTexto");

      // só existe em dias de memória
      if(typeof isMemoryDay !== "function" || !isMemoryDay(dia)){
        esconderMemoriaUI();
        return;
      }

      labelDia.textContent = `Dia ${dia}`;
      box.classList.remove("hidden");

      const liberada = (DIA_ATUAL >= dia);

      // bloqueada até o dia certo
      if(!liberada){
        preview.textContent = "Bloqueada. Volte no Dia 30.";
        btnAbrir.disabled = true;
        btnAbrir.textContent = "Bloqueada";
        btnFechar.classList.add("hidden");
        textoEl.classList.add("hidden");
        textoEl.textContent = "";
        return;
      }

      // liberada
      const memoria = (typeof getMemoriaDoDia === "function") ? getMemoriaDoDia(dia) : "";
      const jaVista = localStorage.getItem(memoriaKeyForDay(dia)) === "1";

      preview.textContent = jaVista
        ? "Você já leu isso uma vez. Mas pode voltar quando quiser."
        : "Uma lembrança guardada. Clique quando estiver pronto.";

      btnAbrir.disabled = false;
      btnAbrir.textContent = "Ler memória";

      btnAbrir.onclick = () => {
        const m = (typeof getMemoriaDoDia === "function") ? getMemoriaDoDia(dia) : "";
        localStorage.setItem(memoriaKeyForDay(dia), "1");

        textoEl.classList.remove("hidden");
        btnFechar.classList.remove("hidden");

        // digitação suave também na memória
        typeText(textoEl, m, 12);

        // depois de abrir, ajusta preview
        preview.textContent = "Você pode fechar e ler de novo quando quiser.";
      };

      btnFechar.onclick = () => {
        textoEl.classList.add("hidden");
        textoEl.textContent = "";
        btnFechar.classList.add("hidden");
        preview.textContent = "Uma lembrança guardada. Clique quando estiver pronto.";
      };
    }

    // ===== render =====

    function carregarPoema(dia){
      DIA_EM_TELA = dia;

      const tituloTopo = document.getElementById("tituloTopo");
      const poemaEl = document.getElementById("poema");
      const metaEl = document.getElementById("meta");

      revelarBloco();
      setTemaPorAto(dia);

      // sempre recalcula memória pro dia em tela
      renderizarMemoria(dia);

      // antes do início
      if(dia <= 0){
        document.body.removeAttribute("data-ato");
        tituloTopo.innerText = "Antes do primeiro poema";
        metaEl.innerText = "";
        const textoPrefacio = (typeof PREFACIO !== "undefined" && PREFACIO) ? PREFACIO : "Em breve.";
        typeText(poemaEl, textoPrefacio, 14);
        return;
      }

      // pós 365
      if(dia > 365){
        tituloTopo.innerText = "365 dias com você";
        metaEl.innerText = "E mesmo assim, eu ainda escolheria você de novo.";
        typeText(poemaEl, "Fim de um ano.\nE o começo de tudo de novo.", 12);
        return;
      }

      // carta
      if(typeof isFinalLetterDay === "function" && isFinalLetterDay(dia)){
        tituloTopo.innerText = "Dia 365 de 365";
        metaEl.innerText = "A carta que fecha — e recomeça.";
        const carta = (typeof CARTA_FINAL !== "undefined" && CARTA_FINAL) ? CARTA_FINAL : "Em breve...";
        typeText(poemaEl, carta, 12);
        return;
      }

      // poema normal
      tituloTopo.innerText = `Dia ${dia} de 365`;
      metaEl.innerText = "Um poema por dia.";

      const texto = (typeof getPoemaDoDia === "function") ? getPoemaDoDia(dia) : "Em breve...";
      typeText(poemaEl, texto, 12);
    }

    function carregarHoje(){
      const d = diffDias();
      DIA_ATUAL = d + 1;

      aplicarFrasePorHorario();
      verificarRetorno();
      iniciarSegredo();

      const btn = document.getElementById("btnAnteriores");
      btn.disabled = (DIA_ATUAL <= 1);

      // garante que sai do arquivo
      sairModoArquivo();

      // antes do início
      if(d < 0){
        esconderIntro();
        carregarPoema(DIA_ATUAL);
        return;
      }

      // intro de virada
      if(deveMostrarIntro(DIA_ATUAL)){
        document.getElementById("tituloTopo").innerText = `Dia ${DIA_ATUAL} de 365`;
        document.getElementById("poema").textContent = "";
        document.getElementById("meta").textContent = "";
        setTemaPorAto(DIA_ATUAL);
        esconderMemoriaUI();
        mostrarIntro(DIA_ATUAL);
        return;
      }

      esconderIntro();
      carregarPoema(DIA_ATUAL);
    }

    // ===== arquivo =====

    function primeiraLinha(texto){
      if(!texto) return "Sem título";
      const linha = String(texto).split("\n")[0].trim();
      return linha || "Sem título";
    }

    function tituloParaLista(dia){
      const texto = (typeof getPoemaDoDia === "function") ? getPoemaDoDia(dia) : "";
      let t = primeiraLinha(texto);
      if(t.length > 52) t = t.slice(0, 52).trim() + "…";
      return t;
    }

    function abrirArquivo(){
      if(DIA_ATUAL <= 1) return;

      const max = DIA_ATUAL - 1;
      document.getElementById("arquivoSub").innerText = `Disponíveis: Dias 1 a ${max}`;

      const lista = document.getElementById("listaArquivo");
      lista.innerHTML = "";

      for(let d = max; d >= 1; d--){
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "arquivoItem";
        btn.innerHTML =
          `<span class="arquivoDia">Dia ${d}</span>
           <span class="arquivoTitulo">${tituloParaLista(d)}</span>`;

        btn.onclick = () => {
          // escolheu um poema antigo -> sai do modo arquivo e mostra o dia escolhido
          sairModoArquivo();
          esconderIntro();
          carregarPoema(d);
        };

        lista.appendChild(btn);
      }

      // tema do arquivo fica no ato do dia atual (fica consistente)
      setTemaPorAto(DIA_ATUAL);
      entrarModoArquivo();
    }

    function voltarParaHoje(){
      carregarHoje();
    }

    function mostrarSaudade(){
      document.getElementById("saudade").classList.toggle("hidden");
    }

    // ===== auth =====

    function verificarSenha(){
      const senha = document.getElementById("senha").value;
      if(senha === senhaCorreta){
        document.getElementById("login").classList.add("hidden");
        document.getElementById("conteudo").classList.remove("hidden");
        setCornerDates();
        carregarHoje();
      } else {
        alert("Senha incorreta.");
      }
    }

    // init
    setCornerDates();
    setInterval(setCornerDates, 60000);
  </script>

</body>
</html>
